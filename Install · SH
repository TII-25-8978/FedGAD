#!/bin/bash

# FedGAD Installation Script for Linux/macOS
# This script automates the installation process

set -e  # Exit on error

echo "=========================================="
echo "FedGAD Installation Script"
echo "=========================================="
echo ""

# Check Python version
echo "Step 1: Checking Python version..."
if command -v python3.12 &> /dev/null; then
    PYTHON_CMD=python3.12
    echo "✓ Python 3.12 found"
elif command -v python3 &> /dev/null; then
    PYTHON_CMD=python3
    PYTHON_VERSION=$($PYTHON_CMD --version 2>&1 | awk '{print $2}')
    echo "✓ Python $PYTHON_VERSION found"
    echo "⚠ Warning: Python 3.12 is recommended"
else
    echo "✗ Python 3 not found. Please install Python 3.8 or higher"
    exit 1
fi

# Create virtual environment
echo ""
echo "Step 2: Creating virtual environment..."
if [ -d "venv" ]; then
    echo "⚠ Virtual environment already exists. Removing..."
    rm -rf venv
fi
$PYTHON_CMD -m venv venv
echo "✓ Virtual environment created"

# Activate virtual environment
echo ""
echo "Step 3: Activating virtual environment..."
source venv/bin/activate
echo "✓ Virtual environment activated"

# Upgrade pip
echo ""
echo "Step 4: Upgrading pip..."
pip install --upgrade pip --quiet
echo "✓ pip upgraded"

# Detect CUDA availability
echo ""
echo "Step 5: Detecting CUDA..."
if command -v nvidia-smi &> /dev/null; then
    CUDA_VERSION=$(nvidia-smi | grep "CUDA Version" | awk '{print $9}')
    echo "✓ CUDA $CUDA_VERSION detected"
    
    # Determine PyTorch CUDA version
    if [[ "$CUDA_VERSION" == 12.* ]]; then
        TORCH_INDEX="https://download.pytorch.org/whl/cu121"
        echo "  Installing PyTorch with CUDA 12.1 support..."
    elif [[ "$CUDA_VERSION" == 11.* ]]; then
        TORCH_INDEX="https://download.pytorch.org/whl/cu118"
        echo "  Installing PyTorch with CUDA 11.8 support..."
    else
        TORCH_INDEX=""
        echo "  Installing CPU-only PyTorch..."
    fi
else
    echo "✗ CUDA not detected"
    TORCH_INDEX=""
    echo "  Installing CPU-only PyTorch..."
fi

# Install PyTorch
echo ""
echo "Step 6: Installing PyTorch..."
if [ -z "$TORCH_INDEX" ]; then
    pip install torch torchvision torchaudio
else
    pip install torch torchvision torchaudio --index-url $TORCH_INDEX
fi
echo "✓ PyTorch installed"

# Install other requirements
echo ""
echo "Step 7: Installing other dependencies..."
pip install -r requirements.txt --quiet
echo "✓ Dependencies installed"

# Create necessary directories
echo ""
echo "Step 8: Creating project directories..."
mkdir -p datasets
mkdir -p results
mkdir -p checkpoints
echo "✓ Directories created"

# Verify installation
echo ""
echo "Step 9: Verifying installation..."
$PYTHON_CMD -c "
import torch
import numpy as np
import sklearn
print(f'PyTorch Version: {torch.__version__}')
print(f'CUDA Available: {torch.cuda.is_available()}')
if torch.cuda.is_available():
    print(f'CUDA Device: {torch.cuda.get_device_name(0)}')
print(f'NumPy Version: {np.__version__}')
print(f'Scikit-learn Version: {sklearn.__version__}')
"
echo "✓ Installation verified"

echo ""
echo "=========================================="
echo "Installation Complete!"
echo "=========================================="
echo ""
echo "Next steps:"
echo "1. Place your datasets in the 'datasets/' directory"
echo "   - ToN_IoT.csv"
echo "   - CSE_CIC_IDS.csv"
echo ""
echo "2. Activate the virtual environment:"
echo "   source venv/bin/activate"
echo ""
echo "3. Run the training script:"
echo "   python main.py"
echo ""
echo "For more information, see README.md"
echo ""
